<!DOCTYPE html>
<html>
<head>
  <title>W4-022: Animation Playback Test at 60 TPS</title>
  <style>
    body { font-family: monospace; background: #222; color: #0f0; padding: 20px; }
    .log { white-space: pre-wrap; word-wrap: break-word; max-height: 600px; overflow-y: auto; border: 1px solid #0f0; padding: 10px; margin: 10px 0; background: #111; }
    .pass { color: #0f0; }
    .fail { color: #f00; }
    button { background: #0f0; color: #000; border: none; padding: 10px 20px; margin: 5px; cursor: pointer; font-weight: bold; }
    button:hover { background: #0f5; }
    h2 { color: #0ff; }
  </style>
</head>
<body>
  <h1>W4-022: Animation Playback Test at 60 TPS</h1>

  <div>
    <button onclick="testIdleAnimation()">Test 1: Idle Smoothness</button>
    <button onclick="testWalkTransition()">Test 2: Walk Transition</button>
    <button onclick="testHysteresis()">Test 3: Hysteresis</button>
    <button onclick="testCooldown()">Test 4: Cooldown</button>
    <button onclick="testJump()">Test 5: Jump Animation</button>
    <button onclick="testRapidChanges()">Test 6: Rapid Changes</button>
    <button onclick="testConcurrent()">Test 7: Concurrent Anim</button>
    <button onclick="clearLog()">Clear Log</button>
  </div>

  <div class="log" id="log"></div>

  <script>
    const log = document.getElementById('log')

    function logMsg(msg, isPass = null) {
      const line = document.createElement('div')
      const timestamp = new Date().toLocaleTimeString()
      line.textContent = `[${timestamp}] ${msg}`
      if (isPass === true) line.className = 'pass'
      if (isPass === false) line.className = 'fail'
      log.appendChild(line)
      log.scrollTop = log.scrollHeight
      console.log(msg)
    }

    function clearLog() {
      log.innerHTML = ''
    }

    function getAnimState() {
      const animator = window.__DEBUG__?.client?.playerAnimator
      if (!animator) return null
      return {
        current: animator.current,
        oneShot: animator.oneShot,
        locomotionCooldown: animator.locomotionCooldown,
        smoothSpeed: animator.smoothSpeed,
        airTime: animator.airTime,
        wasOnGround: animator.wasOnGround
      }
    }

    function getPlayerSpeed() {
      const client = window.__DEBUG__?.client
      if (!client?.player) return 0
      const vel = client.player.velocity || [0, 0, 0]
      return Math.sqrt(vel[0]**2 + vel[2]**2)
    }

    async function wait(ms) {
      return new Promise(r => setTimeout(r, ms))
    }

    async function testIdleAnimation() {
      logMsg('\n=== TEST 1: Idle Animation Smoothness ===')

      // Stop movement
      window.inputHandler?.keys.clear()

      logMsg('Standing idle for 3 seconds...')
      let stateChanges = 0
      let lastState = null
      const startTime = Date.now()

      const checkInterval = setInterval(() => {
        const state = getAnimState()
        if (state) {
          if (state.current !== lastState) {
            stateChanges++
            lastState = state.current
            logMsg(`  [${Date.now() - startTime}ms] State: ${state.current}`, lastState === 'IdleLoop')
          }
        }
      }, 100)

      await wait(3000)
      clearInterval(checkInterval)

      const finalState = getAnimState()
      const pass = finalState?.current === 'IdleLoop' && stateChanges === 0
      logMsg(`Result: ${pass ? 'PASS' : 'FAIL'} (stayed in ${finalState?.current} for 3s, ${stateChanges} changes)`, pass)
    }

    async function testWalkTransition() {
      logMsg('\n=== TEST 2: Walk Transition (0.8 threshold) ===')

      window.inputHandler?.keys.clear()
      await wait(500)

      logMsg('Pressing walk button to move slowly...')
      window.inputHandler?.keys.set('KeyW', true)

      const transitions = []
      const checkInterval = setInterval(() => {
        const state = getAnimState()
        const speed = getPlayerSpeed()
        if (state) {
          transitions.push({ state: state.current, speed: speed.toFixed(2), t: Date.now() })
        }
      }, 50)

      await wait(2000)
      window.inputHandler?.keys.delete('KeyW')
      await wait(1000)
      clearInterval(checkInterval)

      // Find idle to walk transition
      const idleToWalk = transitions.findIndex((t, i) =>
        i > 0 && transitions[i-1].state === 'IdleLoop' && t.state === 'WalkLoop'
      )

      const pass = idleToWalk >= 0
      logMsg(`Transitions recorded: ${transitions.length}`, pass)
      if (pass) {
        const t = transitions[idleToWalk]
        logMsg(`  IdleLoop→WalkLoop happened at speed ${t.speed}`, t.speed > 0.7 && t.speed < 1.0)
      }
      logMsg(`Result: ${pass ? 'PASS' : 'FAIL'}`, pass)
    }

    async function testHysteresis() {
      logMsg('\n=== TEST 3: Hysteresis (prevent oscillation) ===')

      window.inputHandler?.keys.clear()
      await wait(500)

      logMsg('Moving in 0.3-0.8 speed zone (should prevent oscillation)...')
      window.inputHandler?.keys.set('KeyW', true)

      const states = []
      const startTime = Date.now()
      const checkInterval = setInterval(() => {
        const state = getAnimState()
        const speed = getPlayerSpeed()
        states.push({ state: state?.current, speed: speed.toFixed(2), t: Date.now() - startTime })
      }, 50)

      await wait(3000)
      window.inputHandler?.keys.delete('KeyW')
      clearInterval(checkInterval)

      // Count state changes
      const changes = states.filter((s, i) => i > 0 && s.state !== states[i-1].state).length
      const pass = changes < 5 // Should not oscillate rapidly

      logMsg(`State changes in 3s: ${changes}`, pass)
      if (changes > 0) {
        logMsg('Transitions:')
        states.filter((s, i) => i === 0 || s.state !== states[i-1].state).forEach(s => {
          logMsg(`  [${s.t}ms] ${s.state} @ speed ${s.speed}`)
        })
      }
      logMsg(`Result: ${pass ? 'PASS' : 'FAIL'} (expected < 5 changes, got ${changes})`, pass)
    }

    async function testCooldown() {
      logMsg('\n=== TEST 4: Cooldown (0.3s between locomotion changes) ===')

      window.inputHandler?.keys.clear()
      await wait(500)

      logMsg('Attempting rapid state changes...')
      const transitions = []
      let lastTransitionTime = 0
      let tooRapid = false

      const checkInterval = setInterval(() => {
        const state = getAnimState()
        const speed = getPlayerSpeed()
        const now = Date.now()

        if (transitions.length === 0 || state.current !== transitions[transitions.length - 1].state) {
          const timeSinceLast = now - lastTransitionTime
          if (transitions.length > 0 && timeSinceLast < 250) {
            tooRapid = true
            logMsg(`  Too-rapid transition: ${timeSinceLast}ms apart!`, false)
          }
          transitions.push({ state: state.current, speed: speed.toFixed(2), time: now })
          lastTransitionTime = now
        }
      }, 50)

      // Fast speed changes
      window.inputHandler?.keys.set('KeyW', true)
      await wait(500)
      window.inputHandler?.keys.delete('KeyW')
      await wait(200)
      window.inputHandler?.keys.set('KeyW', true)
      await wait(500)
      window.inputHandler?.keys.delete('KeyW')

      await wait(500)
      clearInterval(checkInterval)

      const pass = !tooRapid
      logMsg(`Transitions: ${transitions.length}`, pass)
      logMsg(`Result: ${pass ? 'PASS' : 'FAIL'} (no rapid changes detected)`, pass)
    }

    async function testJump() {
      logMsg('\n=== TEST 5: Jump Animation ===')

      window.inputHandler?.keys.clear()
      await wait(500)

      logMsg('Jumping...')
      const states = []

      const checkInterval = setInterval(() => {
        const state = getAnimState()
        states.push(state?.current || 'unknown')
      }, 50)

      window.inputHandler?.keys.set('Space', true)
      await wait(100)
      window.inputHandler?.keys.delete('Space')

      await wait(2000)
      clearInterval(checkInterval)

      // Check for jump animations
      const hasJump = states.some(s => s === 'JumpStart' || s === 'JumpLoop')
      const hasLand = states.some(s => s === 'JumpLand')

      logMsg(`Jump animations: ${hasJump ? 'found' : 'missing'}`, hasJump)
      logMsg(`Land animation: ${hasLand ? 'found' : 'skipped'}`)

      const uniqueStates = [...new Set(states)]
      logMsg(`State sequence: ${uniqueStates.join(' → ')}`)
      logMsg(`Result: ${hasJump ? 'PASS' : 'FAIL'}`, hasJump)
    }

    async function testRapidChanges() {
      logMsg('\n=== TEST 6: Rapid Movement Changes ===')

      window.inputHandler?.keys.clear()
      await wait(500)

      logMsg('Rapid movement changes...')
      const crashes = []

      const originalError = window.onerror
      window.onerror = (msg, url, line, col, err) => {
        crashes.push({ msg, line })
        return false
      }

      // Rapid W/A/S/D changes
      for (let i = 0; i < 10; i++) {
        window.inputHandler?.keys.set('KeyW', true)
        await wait(50)
        window.inputHandler?.keys.set('KeyA', true)
        await wait(50)
        window.inputHandler?.keys.delete('KeyW')
        window.inputHandler?.keys.set('KeyS', true)
        await wait(50)
        window.inputHandler?.keys.delete('KeyA')
        window.inputHandler?.keys.set('KeyD', true)
        await wait(50)
        window.inputHandler?.keys.clear()
      }

      window.onerror = originalError

      const pass = crashes.length === 0
      logMsg(`Errors: ${crashes.length}`, pass)
      if (crashes.length > 0) {
        crashes.forEach(c => logMsg(`  ${c.msg} @ line ${c.line}`))
      }
      logMsg(`Result: ${pass ? 'PASS' : 'FAIL'} (no crashes during rapid changes)`, pass)
    }

    async function testConcurrent() {
      logMsg('\n=== TEST 7: Concurrent Animations ===')

      window.inputHandler?.keys.clear()
      await wait(500)

      logMsg('Walking while aiming...')
      window.inputHandler?.keys.set('KeyW', true)

      await wait(500)

      // Simulate aim input (right mouse)
      window.inputHandler?.aiming = true
      logMsg('  Aiming activated...')

      await wait(1000)

      window.inputHandler?.aiming = false
      window.inputHandler?.keys.delete('KeyW')

      await wait(500)

      const state = getAnimState()
      const pass = state?.current !== null
      logMsg(`Final state: ${state?.current}`, pass)
      logMsg(`Result: ${pass ? 'PASS' : 'FAIL'} (concurrent animations handled)`, pass)
    }

    logMsg('Animation Test Suite Ready. Click buttons to run tests.')
    logMsg(`Server tick rate: should be 60 TPS (check browser network tab)`)
    logMsg(`Mixer timeScale: 1.3, Walk: 2.0, Sprint: 0.56`)
  </script>
</body>
</html>
